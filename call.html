<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />

        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"
        />
        <meta name="robots" content="noindex, nofollow" />
        <meta name="referrer" content="no-referrer" />

        <title>Call</title>

        <meta name="mobile-web-app-capable" content="yes" />
        <meta name="application-name" content="Mattermost" />
        <meta name="format-detection" content="telephone=no" />

        <link
            rel="icon"
            type="image/png"
            href="/static/images/favicon/favicon-default-16x16.png"
            sizes="16x16"
        />
        <link
            rel="icon"
            type="image/png"
            href="/static/images/favicon/favicon-default-24x24.png"
            sizes="24x24"
        />
        <link
            rel="icon"
            type="image/png"
            href="/static/images/favicon/favicon-default-32x32.png"
            sizes="32x32"
        />
        <link
            rel="icon"
            type="image/png"
            href="/static/images/favicon/favicon-default-64x64.png"
            sizes="64x64"
        />
        <link
            rel="icon"
            type="image/png"
            href="/static/images/favicon/favicon-default-96x96.png"
            sizes="96x96"
        />
        <style>
            body {
                display: flex;
                flex-direction: column;
                height: 100vh;
            }
        </style>
    </head>
    <body>
        <div id="app"></div>
    </body>

    <script src="https://kmeet.preprod.dev.infomaniak.ch/external_api.js"></script>
    <script>
        const KMEET_DOMAIN = 'kmeet.preprod.dev.infomaniak.ch';
        const urlParams = new URLSearchParams(window.location.search);
        const events = {
            'audioMuteStatusChanged': window.opener.audioMuteStatusChanged,
            'participantJoined': window.opener.onParticipantJoined
        }

        const configOverwrite = {
            startWithAudioMuted: false,
            startWithVideoMuted: true,
            subject: urlParams.get('channelID'),
            prejoinConfig: {enabled: false},
            disableDeepLinking: true,
        };

        const jitsi = new window.JitsiMeetExternalAPI(KMEET_DOMAIN, {
            configOverwrite,
            roomName: urlParams.get('channelID'),
            // onload: (self) => {
            //     console.log(self);
            // },
        });

        for (const [event, callback] of Object.entries(events)) {
            jitsi.addListener(event, callback)
        }

        jitsi.on('readyToClose', () => window.opener.onCloseJitsi(window))
        window.onclose = () => window.opener.onclose

        // window.opener.jitsi = jitsi

        // window.opener.executeCommand = jitsi.executeCommand
        window.opener.executeCommand = (command) => jitsi.executeCommand(command)

        console.log(j);
    </script>
</html>
