include:
  - project: 'docker-public/gitlab-ci-dev-scripts'
    ref: master
    file: '/build-docker-image.yaml'

unit_test:
  stage: test
  image: node:16.14.2-bullseye
  tags:
    - docker-executor
    - kubernetes
    - shared
  rules:
    - if: $CI_COMMIT_TAG
      when: on_success
    - if: '$CI_MERGE_REQUEST_ID'
      when: on_success
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: never
  artifacts:
    paths:
      - coverage/
    when: on_success
    reports:
      junit:
        - coverage/junit.xml
  coverage: '/^\s*Lines\s*: \d+\d+.\d+\d+\%/'
  cache:
    key:
      files:
        - package-lock.json
      prefix: ${CI_COMMIT_REF_SLUG}
    paths:
      - .npm/
      - node_modules/
      - coverage/
  before_script:
    - npm ci --cache .npm
  script:
    # typescript
    # - npm run check-types

    # lint
    # - npm run check

    # unit tests
    - npm run test-ci

update-changelog:
  stage: test
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "alpha"'
      when: on_success
    - when: never
  script:
    - latestVersion=$(git describe --tags --abbrev=0)
    - currentVersion=$(grep -oP '(?<=VERSION ")([^"]*)' version.h)
    - |
      curl --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" --data "version=$currentVersion&from=$latestVersion&to=release&branch=release" "https://gitlab.infomaniak.ch/api/v4/projects/3225/repository/changelog"

pages:
  stage: test
  needs: ['unit_test']
  script:
    - mkdir .public
    - cp -r coverage/* .public
    - mv .public public
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_TAG
      when: on_success
    - if: '$CI_MERGE_REQUEST_ID'
      when: on_success
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: never
  # only:
  #   - alpha